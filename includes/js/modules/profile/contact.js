var ContactModel=Backbone.Model.extend({defaults:{contact_type:"Home",contact:"",im_tag:"",is_primary:false,last:true,first:true},url:function(){if(this.isNew()){return BASE_URL+"api/contact/"}else{return BASE_URL+"api/contact/id/"+this.get("id")}},validate:function(a){if(a.contact==""){return"This field must not be left blank."}}});var ContactCollection=Backbone.Collection.extend({model:ContactModel,url:BASE_URL+"api/user/contact"});var EditContactView=Backbone.View.extend({el:$("#myContacts"),events:{"click #contacts-submit":"saveCollection"},initialize:function(){this.render()},render:function(){var d=this;var c=[];var a=[];var b=[];_.each(this.collection.models,function(e){if(e.get("contact_type")=="Home"||e.get("contact_type")=="Fax"||e.get("contact_type")=="Work"){a.push(e)}else{if(e.get("contact_type")=="Mobile"){c.push(e)}else{b.push(e)}}});if($(b).size()==0){e_model=new ContactModel({contact_type:"IM"});b.push(e_model);this.collection.push(e_model)}if($(c).size()==0){e_model=new ContactModel({contact_type:"Mobile"});c.push(e_model);this.collection.push(e_model)}if($(a).size()==0){e_model=new ContactModel();a.push(e_model);this.collection.push(e_model)}mobileContactGroup=new ContactGroupEditView({models:c,container:"mobile",collection:this.collection});otherContactGroup=new ContactGroupEditView({models:a,container:"other",collection:this.collection});imContactGroup=new ContactGroupEditView({models:b,container:"im",collection:this.collection})},saveCollection:function(c){var a=this;this.valid=true;_.each(this.collection.models,function(d){console.log(d.collection.validate);if(!d.isValid()){this.valid=false}},this);if(this.valid){var b=0;_.each(this.collection.models,function(d){$(c.target).text("Saving...").attr("disabled",true);d.save("","",{success:function(){a.closeDialog(++b)},wait:true})},this)}},closeDialog:function(a){if(a==this.collection.length){this.$el.modal("hide");$("#contacts-submit").text("Submit Changes").attr("disabled",false);im_primary=this.collection.where({is_primary:true,contact_type:"IM"});if($(im_primary).size()==0){im_primary=this.collection.where({contact_type:"IM"})}if($(im_primary).size()>0){$("#im-primary").text(im_primary[0].get("contact"))}mobile_primary=this.collection.where({is_primary:true,contact_type:"Mobile"});if($(mobile_primary).size()==0){mobile_primary=this.collection.where({contact_type:"Mobile"})}if($(mobile_primary).size()>0){$("#mobile-primary").text(mobile_primary[0].get("contact"))}}}});var ContactGroupEditView=Backbone.View.extend({tagName:"div",initialize:function(){this.render()},events:{"click .add-new":"addNew"},addNew:function(a){model=new ContactModel({last:true,first:false,contact_type:$(a.target).parent().attr("rel")});if(model.get("contact_type")=="IM"){model.set("im_tag","AIM")}this.options.models.push(model);this.collection.models.push(model);this.render()},render:function(){this.count=$(this.options.models).size();this.$el=$("#container-"+this.options.container);var a=this;this.$el.empty();$.each(this.options.models,function(d,c){if(d==0){c.set("first",true)}else{c.set("first",false)}if(d+1==a.count){c.set("last",true)}else{c.set("last",false)}var b=new ContactItemEditView({model:c,collection:this.collection,container:a.options.container});a.$el.append(b.render().el)});return this}});var ContactItemEditView=Backbone.View.extend({tagName:"div",events:{'change input[type!="radio"],select':"change",'click input[type="radio"]':"changePrimary"},initialize:function(){var a=this;this.model.on("error",function(d,c){var b=_.template($("#alert-template").html());a.$el.find(".controls").after(b({message:c}))})},changePrimary:function(){var a=this;this.model.set("is_primary",true);_.each(_.filter(this.collection.models,function(b){return b.get("contact_type")==a.model.get("contact_type")&&b.get("id")!=a.model.get("id")}),function(b){b.set("is_primary",false,{silent:true})})},change:function(a){change={};change[$(a.target).attr("name")]=$(a.target).val();this.model.set(change,{silent:true})},render:function(){this.template=$("#"+this.options.container+"-input-template").html();var a=_.template(this.template);this.$el.html(a(this.model.toJSON()));return this}});